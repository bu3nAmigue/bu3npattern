<!doctype html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Title -->

<title>bu3nPattern</title>
<meta property="og:title" content="bu3nPattern">

<!--Favicon-->
<link rel="icon" href="https://mathigatti.com/favicon/favicon.png">

<!--Preview Images-->

<meta property="og:image" content="https://bu3namigue.github.io/bu3npattern/demo.gif">
<link rel="image_src" href="/demo.gif">

<!--Description-->

<meta name="description" content="Apply real time pattern effects to your webcam online">
<meta property="og:description" content="Apply real time pattern effects to your webcam online">

<!--Author-->

<meta name="author" content="bu3nAmigue">


<script src="https://cdn.jsdelivr.net/npm/twgl.js@4.15.0/dist/4.x/twgl-full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.7/build/dat.gui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.3.4/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.3.4/EasePack.min.js"></script>
<script type="text/javascript"
        src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="module" src="ca.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
    integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
<link href="/styles.css" rel="stylesheet">
</head>
<body>
   <a id="screenshot" class="info">
     <span class="fab fas fa-camera-retro fa-2x"></span>
      <span class="text">Take screenshot</span>
   </a>

  <a id="btn" class="info">
    <span class="fab fas fa-plus-circle "></span>
    <span class="text">Add new pattern</span>
  </a>

  <div id="showInfo" class="modal">
    <div class="modal-header">
      <p>bu3n pattern</p>
      <span class="close">&times;
      </span>
    </div>
    <div class="modal-content">
      <form enctype="multipart/form-data">
        <p>Create your own effect by adding a customized pattern.</p>
        <p>Generate a personalized model from images using <a href="https://colab.research.google.com/drive/1KMlVFi2zXhE0_PHCBXC07oblcJf9E13s" target="_blank">this colab</a></p>
        <p>After you download the models JSON file</p>
        <p>Load it and try it! </p>
        <input class="button" id="upload" type="file"   accept="text/json" value="Upload JSON here!" size="60"/>
        <label for="upload">Upload file</label>

</form>
    </div>
  </div>
  </div>
  <a href="https://github.com/bu3nAmigue/bu3npattern" class="info"
    title="View source on Github">
    <span class="fab fa-github"></span>
    <span class="text">View source</span>
  </a>

<canvas id="glCanvas"  style='z-index: 1'></canvas>
<script src="/helper.js"></script>
<script src="/canvas2blob.js"></script>
<script src="/FileSaver.js"></script>
<script type="module">
  import { CA } from "./ca.js"

  const canvas = document.querySelector('#glCanvas');
  const devicePixelRatio = window.devicePixelRatio || 1;
  const quality = .5;
  const gl = canvas.getContext("webgl");
  const W = 256, H = 256;
  var videoLoaded = false;
  let ca;

  resizeGLCanvas(window.innerWidth, window.innerHeight);

  function resizeGLCanvas(width, height) {
      canvas.width = width / quality;
      canvas.height = height / quality;

      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';

      gl.viewport(0, 0, canvas.width, canvas.height);

  }


 

  const video = document.createElement('video');
  video.autoplay="";
  video.style="display:none";
  video.id="feedCam";

  const param = {
    active: true,
    model: 132,
    zoom: 0.,
    speed: 1,
    paintMode: false,
  };

  function create_gui(){
    var gui = new dat.GUI();
    gui.add(param, 'active');
    gui.add(param, 'zoom', -0.5, .5).step(0.0001);
    gui.add(param, 'speed', 0, 6);
    return gui;
  }

  var gui = create_gui();
  let name2idx, modelController;

  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && video) {
      var constraints = {audio: false, video: true};

      navigator.mediaDevices.getUserMedia( constraints ).then( function ( stream ) {
          video.playsInline = true;
          video.srcObject = stream;
          video.play();
          videoLoaded = true;
          ca.loadVideoTexture(video);

      } ).catch( function ( error ) {
          console.error( 'Unable to access the camera/webcam.', error );

      } );

  } else {
      console.error( 'MediaDevices interface not available.' );
  }

  function update_model(models){
      ca.setWeights(models);
      name2idx = Object.fromEntries(models.model_names.map((s, i) => [s, i]));
      gui.remove(modelController);
      modelController = gui.add(param, 'model').options(name2idx).listen();
      param.model=0;
  }

  function load_model(models) {
      ca = new CA(gl, models, [W, H], gui);
      window.ca = ca;
      ca.alignment = 0;
      
      name2idx = Object.fromEntries(models.model_names.map((s, i) => [s, i]));
      modelController = gui.add(param, 'model').options(name2idx).listen();

      ca.paint(128, 128, 1000, param.model);


      $( ".target" ).change(function() {
        alert( "Handler for .change() called." );
      });

      window.screenshotshot = false;
      function render() {
          if (!screenshotshot){
          if (videoLoaded){
              ca.updateVideoTex(video);
          }

          if (param.active) {
            //ca.clearCircle(Math.sin(t * 2.0) * W / 3 + W / 2, Math.cos(t * 3.1) * H / 3 + H / 2, 20);
            for (let i=0; i<param.speed; ++i) ca.step('all', param.zoom);
          }

          twgl.bindFramebufferInfo(gl);
          gl.viewport(0, 0, canvas.width, canvas.height);
          ca.draw();
       
          requestAnimationFrame(render);
          ca.paint(128, 128, 1000, param.model);
      }
      }
         requestAnimationFrame(render);
         
  }
  const saveBlob = (function() {
      const a = document.createElement('a');
      document.body.appendChild(a);
      a.style.display = 'none';
      return function saveData(blob, fileName) {
          const url = window.URL.createObjectURL(blob);
          a.href = url;
          a.download = fileName;
          a.click();
          window.screnshotshot = false;
      };
  }());

  var screenshot =  document.getElementById("screenshot");
  screenshot.onclick = function(event)
  {
      var canvas =  document.getElementById('glCanvas'),
          glContextAttributes = { preserveDrawingBuffer: true },
		  ctx = canvas.getContext("experimental-webgl", glContextAttributes);


      canvas.toBlob((blob) => {
          window.screnshotshot = true;
          saveBlob(blob, `screencapture-${canvas.width}x${canvas.height}.png`);
      });

  };

  fetch('data/models.json').then(r => r.json()).then(models => {
      console.log(models);
      load_model(models);
  });

  function handleFileSelect(evt) {
      var files = evt.target.files;
      var f = files[0];
      var reader = new FileReader();

      reader.onload = (function(theFile) {
          return function(e) {
            var models = e.target.result;
            var json_models = JSON.parse(models);
         
            update_model(json_models);
          };
      })(f);

      reader.readAsText(f);
  }

  document.getElementById('upload').addEventListener('change', handleFileSelect, false);

</script>
</body>
